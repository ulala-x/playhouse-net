syntax = "proto3";

package playhouse.runtime;

option csharp_namespace = "PlayHouse.Runtime.Proto";

// ============================================
// Server-to-Server Communication Protocol
// Used for ZMQ Router-Router messaging
// ============================================

// Route header for server-to-server messages
// 3-Frame message structure:
//   Frame 0: Target NID (UTF-8 string)
//   Frame 1: RouteHeader (this message, serialized)
//   Frame 2: Payload (binary)
message RouteHeader {
    // Message sequence number for request-reply matching (1-65535)
    uint32 msg_seq = 1;

    // Service ID of the sender
    uint32 service_id = 2;

    // Message ID (string identifier)
    string msg_id = 3;

    // Error code (0 = success)
    uint32 error_code = 4;

    // Sender NID (for reply routing)
    string from = 5;

    // Target stage ID
    int64 stage_id = 6;

    // Account ID (for actor-level routing)
    int64 account_id = 7;

    // Session ID (for client session tracking)
    int64 sid = 8;

    // Is this a reply packet? (true = reply, false = request)
    bool is_reply = 9;

    // Payload size in bytes (for MessagePool.Rent)
    uint32 payload_size = 10;
}

// ============================================
// System Commands for Stage Management
// ============================================

// Create a new stage
message CreateStageReq {
    string stage_type = 1;
    string payload_id = 2;
    bytes payload = 3;
}

message CreateStageRes {
    bool result = 1;        // true = success, false = failure
    string payload_id = 2;
    bytes payload = 3;
}

// Get or create a stage
message GetOrCreateStageReq {
    string stage_type = 1;
    string create_payload_id = 2;
    bytes create_payload = 3;
    string join_payload_id = 4;
    bytes join_payload = 5;
}

message GetOrCreateStageRes {
    bool result = 1;        // true = success, false = failure
    bool is_created = 2;    // true = new stage created, false = existing stage or failed
    string payload_id = 3;
    bytes payload = 4;
}

// Destroy a stage
message DestroyStageReq {
    int64 stage_id = 1;
}

// ============================================
// Timer Messages
// ============================================

// Timer operation message
message TimerMsg {
    enum Type {
        REPEAT = 0;    // Infinite repeat timer
        COUNT = 1;     // Limited count timer
        CANCEL = 2;    // Cancel existing timer
    }

    Type type = 1;
    int64 timer_id = 2;
    int64 stage_id = 3;
    int64 initial_delay_ms = 4;
    int64 period_ms = 5;
    int32 count = 6;       // For COUNT type only
}

// ============================================
// Connection State Messages
// ============================================

// Actor disconnected notification
message DisconnectNoticeMsg {
    int64 account_id = 1;
    string session_nid = 2;
    int64 sid = 3;
}

// Actor reconnected notification
message ReconnectMsg {
    int64 account_id = 1;
    string session_nid = 2;
    int64 sid = 3;
    string api_nid = 4;
}
