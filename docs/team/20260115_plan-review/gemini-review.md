# 통합 테스트 전환 계획서(plan.md) 리뷰

## 1. 문서 구조와 가독성
- **구조적 명확성**: '핵심 원칙' → '개요' → '기능 목록' → '구조 설계' → '상세 구현'으로 이어지는 논리적 흐름이 매우 명확합니다.
- **예제 코드**: 각 원칙(Server Once, Proto Message Driven)에 대한 `Client` 측면의 구체적인 코드 예시가 포함되어 있어, 구현 목표를 쉽게 이해할 수 있습니다.
- **테스트 매핑 테이블**: 기존 73개 테스트 케이스를 기능별로 분류하고, 사용할 Proto Message와 매핑한 표는 구현 시 체크리스트로 활용하기에 매우 유용합니다.

## 2. E2E 테스트 원칙 준수 여부
- **내부 상태 접근 차단**: 계획서 전반에 걸쳐 `TestStageImpl`, `TestActorImpl` 등의 서버 내부 상태 검증을 배제하고, 오직 **Client Response(Proto Reply)** 만을 통해 검증하겠다는 원칙이 강력하게 적용되어 있습니다.
- **실제 통신 환경**: Mocking을 최소화하고, 실제 TCP/ZMQ 소켓 통신을 통해 클라이언트와 서버가 통신하는 구조를 채택하여 신뢰도 높은 E2E 검증이 가능합니다.
- **블랙박스 테스트**: 클라이언트 입장에서 서버를 블랙박스로 취급하는 접근 방식이 잘 정립되어 있습니다.

## 3. 성능 개선 효과 (서버 재시작 제거)
- **Server Once Pattern**: 기존 xUnit의 `Fact`나 `ClassFixture` 단위의 재시작 비용을 제거하고, 프로그램 시작 시 **단 1회** 서버를 구동하는 전략은 테스트 실행 속도를 획기적으로 단축시킬 것으로 예상됩니다.
- **연결 유지**: 클라이언트 연결(`Connector`)도 재사용하되, 필요한 경우에만 재연결하거나 상태를 초기화하는 방식은 불필요한 핸드셰이크 오버헤드를 줄여줍니다.

## 4. 실제 구현 시 발생할 수 있는 문제점 및 제안
### 4.1. 포트 충돌 가능성 (CI 환경)
- **현황**: `ApiServer`의 ZMQ 포트가 `15300`, `15301`로 고정되어 있습니다.
- **리스크**: CI 서버에서 병렬로 여러 Job이 실행되거나, 로컬에서 개발자가 두 개의 검증 프로그램을 동시에 띄울 경우 포트 충돌(AddressAlreadyInUse)이 발생할 수 있습니다.
- **제안**: `ServerFactory`에서 TCP 포트처럼 ZMQ 포트도 동적 할당(`0` 사용)하거나, 환경 변수/인자로부터 포트 오프셋을 받을 수 있도록 설계하는 것이 안전합니다.

### 4.2. 테스트 격리(Isolation)의 인적 오류
- **현황**: "Verifier별 고유 ID 사용"을 원칙으로 하지만, 이는 개발자의 주의에 의존합니다.
- **리스크**: 코드를 복사/붙여넣기 하다가 ID를 수정하지 않으면 테스트 간 간섭이 발생하여 디버깅이 어려운 간헐적 실패(Flaky Test)를 유발할 수 있습니다.
- **제안**: `VerifierBase` 레벨에서 `GenerateUniqueId(string prefix)` 같은 헬퍼 메서드를 제공하여, 자동으로 고유성이 보장된 ID(예: `conn_test_{Guid}`)를 생성해서 사용하도록 강제하는 것이 좋습니다.

### 4.3. IDE 통합 기능 상실
- **이슈**: xUnit 기반이 아니므로 Visual Studio나 Rider의 **Test Explorer**에서 개별 테스트를 실행하거나 디버깅하는 기능을 사용할 수 없습니다.
- **대안**: 계획서에 명시된 "Interactive Mode"가 이를 어느 정도 대체하지만, 특정 테스트 하나만 브레이크포인트를 걸고 디버깅하려면 CLI 인자(`--category` 등)를 매번 세팅해야 하는 번거로움이 있습니다. 팀원들에게 이 변경 사항(워크플로우 변화)을 미리 공유해야 합니다.

## 5. playhouse-sample-net 패턴과의 일관성
- **일치**: `Program.cs`에서 루프를 돌며 검증 메뉴를 제공하는 방식, `ServerContext`를 공유하는 방식 등은 `playhouse-sample-net`에서 제시하는 "자체 검증 클라이언트(Verification Client)" 패턴과 일치하는 것으로 보입니다.
- **적절성**: 프레임워크 자체를 검증하는 목적에는 일반적인 단위 테스트 프레임워크(xUnit)보다, 이러한 통합 검증 프로그램 형태가 시나리오 제어와 상태 관리에 더 적합합니다.

## 6. 누락된 고려사항이나 리스크
- **타임아웃 정책**: `RunTest`에 60초 타임아웃이 설정되어 있으나, 전체 테스트 슈트 실행 시의 타임아웃(CI job timeout)과는 별개입니다. 행(Hang)이 걸렸을 때 TAP 결과를 출력하지 못하고 강제 종료될 경우 원인 파악이 어려울 수 있습니다.
  - *제안*: 타임아웃 발생 시 현재 스택 트레이스나 마지막 로그를 덤프하는 로직 추가 고려.
- **로그 가시성**: 서버 로그와 클라이언트(Verifier) 로그가 섞여서 출력될 것입니다. 테스트 실패 시, 해당 테스트 구간의 서버 로그만 필터링해서 보기가 어려울 수 있습니다.
  - *제안*: `Verifier` 시작/종료 시점에 로그에 구분선(`---- Start Test: Name ----`)을 명확히 출력하여 가시성을 확보해야 합니다.

## 종합 의견
이 계획서는 **성능**과 **유지보수성** 두 마리 토끼를 잡을 수 있는 매우 견고한 계획입니다. 특히 **"응답 패킷으로만 검증한다"**는 철학은 향후 서버 내부 구현이 변경되더라도 테스트 코드를 수정할 필요를 최소화하여 PlayHouse 프레임워크의 안정성을 크게 높여줄 것입니다.

**승인 여부**: **강력 추천 (Highly Recommended)**
단, 구현 시 **ZMQ 포트 동적 할당**과 **ID 생성 헬퍼** 부분만 보완하면 완벽할 것입니다.
