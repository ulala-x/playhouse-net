# PlayHouse-NET 통합 검증 프로그램 전환 계획 리뷰

## 1) Server Once Pattern 설계

**장점**
- 서버/클라이언트 생명주기를 단순화하고 실행 시간을 줄이는 방향은 타당합니다.
- CI 모드(TAP 출력)에서 빠르게 전체 회귀를 보는 데 유리합니다.

**리스크 및 보완 필요 지점**
- **서버 종료 테스트와의 충돌**: `ServerLifecycle`에서 서버 종료로 인한 `OnDisconnect`를 검증하려면 실제 서버를 중지해야 합니다. 그런데 Server Once Pattern은 프로그램 종료 시 1회 정리를 전제합니다. 
  - 권장: 별도 “임시 서버 인스턴스” 또는 “서버 프로세스 분리” 방식으로 해당 테스트만 독립 실행.
- **핸들러 누적 문제**: `SetupAsync`에서 `Connector.OnReceive += ...`만 하고 해제하지 않으면 Verifier가 누적되며 테스트 간 간섭이 생깁니다. 
  - 권장: `TeardownAsync`에서 핸들러 해제 또는 Verifier마다 전용 Connector 생성.
- **상태 공유로 인한 편향**: 인증/스테이지 생성/타이머가 누적될 수 있어 뒤쪽 테스트가 이전 상태에 의존하는 상황이 발생할 수 있습니다. 
  - 권장: 명시적 정리 메시지/계정 범위 분리 외에 “리셋 전용 API” 또는 “테스트 전용 네임스페이스”를 제공해 상태를 예측 가능하게 유지.

**판단**: Server Once Pattern 자체는 타당하나, “서버 종료 검증” 및 “핸들러 누적/상태 누수” 문제를 먼저 해결하지 않으면 안정성이 떨어집니다.

---

## 2) Proto Message Driven 접근 완전성 (CPacket.Empty 사용 여부)

**긍정적 요소**
- “모든 테스트는 proto 정의” 원칙을 명시적으로 선언하여 테스트가 문서화되고, 변경 추적에 유리합니다.

**누락/불명확 지점**
- **ErrorPacket, Disconnect 등 실제 사용 항목이 Proto 목록에 없음**
  - 테스트 표에 `ErrorPacket`, `Disconnect`가 등장하지만, “Proto Message 전체 목록(48개)”에 포함되어 있지 않습니다.
- **Proto 정의 없음이라고 명시된 테스트가 존재**
  - `StageToApi`의 “S2S 직접 라우팅”은 “proto 정의 없음, 제외 또는 추가 필요”로 남아 있어 원칙 위반 가능성이 있습니다.
- **DIIntegration 3~4번**: “API 서버에서 직접 요청”은 실제 메세지 정의가 표에 없습니다. 이는 Proto Message Driven 원칙과 상충합니다.

**판단**: CPacket.Empty를 배제하는 방향은 옳으나, 현재 문서 상으로는 **“정의 없는 메시지/패킷”이 남아 있어 완전하지 않음**. 테스트에 쓰이는 모든 상호작용을 proto로 모델링해야 합니다.

---

## 3) Client Response Only 검증 패턴 일관성

**긍정적 요소**
- “서버 내부 상태 접근 금지” 원칙이 명확하며 예시 코드도 응답 기반 검증을 지향합니다.

**일관성 리스크**
- **콜백 검증의 실제 의미성**: `ActorCallback`, `StageCallback` 계열은 “응답 성공”만으로 콜백 호출을 간접 검증합니다. 
  - 실제로 콜백이 호출되지 않아도 같은 성공 응답을 생성할 수 있는 구조라면 **거짓 양성** 가능성이 있습니다.
  - 권장: “콜백 내에서만 가능한 응답 필드/값”을 추가하여 콜백 호출을 응답에 반영.
- **Push 검증의 기준 불명확**: `OnReceive`로 Push를 확인하더라도, 어떤 경로에서 발생했는지 명확히 구분되지 않을 수 있습니다.
  - 권장: Push 메시지에 테스트 실행 ID/StageId를 포함하여 출처를 검증.

**판단**: 방향은 맞지만, **콜백 검증의 식별성**을 강화해야 일관된 E2E 검증이 됩니다.

---

## 4) 테스트 격리 전략 충분성

**현재 전략**
- Verifier별 고유 UserId/StageId 사용
- 최소 정리 메시지

**부족한 부분**
- **이벤트 핸들러 및 타이머 누수**: `OnReceive` 누적, 타이머/AsyncBlock Push가 다른 테스트와 섞일 위험이 있습니다.
- **스테이지/세션 수명 관리**: Verifier마다 Stage 생성 후 명시적 Close가 보장되지 않으면 상태가 남습니다.
- **성능 테스트와 일반 테스트 간 간섭**: `ConnectorCallbackPerformance`는 타이밍에 민감하여 다른 테스트의 background 작업이 영향을 줄 수 있습니다.

**권장 보완**
- Verifier마다 핸들러 등록/해제 보장.
- Stage/Timer/AsyncBlock 관련 테스트는 반드시 정리 API 호출 또는 “테스트 전용 리셋 메시지” 추가.
- 성능 테스트는 별도 카테고리 또는 `--category`로 단독 실행 권장.

**판단**: 현재 제시된 격리 전략만으로는 **상호 간섭을 완전히 막기 어렵습니다**.

---

## 5) 73개 테스트와 48개 proto message 매핑 정확성

**관찰된 불일치**
- 테스트 표에는 `ErrorPacket`, `Disconnect` 등의 패킷이 등장하지만, Proto 목록에 포함되어 있지 않습니다.
- `StageToApi`의 “S2S 직접 라우팅”은 proto 미정.
- `DIIntegration` 3~4번은 proto 없이 “API 서버에서 직접 요청”으로 서술됨.
- `ServerLifecycle`/`Connection` 일부는 “연결 실패/서버 종료”로 proto 매핑이 생략되어 있음.

**판단**
- “73개 테스트 ↔ 48개 proto 메시지” 매핑이 **완전하다고 보기 어렵습니다**. 
  - 누락된 메시지를 proto 목록에 포함시키거나, 해당 테스트는 “proto 매핑 제외 테스트”로 명시해 분리해야 합니다.
  - 특히 “ErrorPacket/Disconnect”는 실제 검증 대상이므로 명시적 리스트에 포함하는 것이 바람직합니다.

---

## 6) 구현 단계(Phase 1-4) 현실성

**현실적 요소**
- 단계별로 인프라 → 기본 Verifier → 고급 Verifier → 정리 흐름은 합리적입니다.

**리스크**
- **Day 3~10에 17개 Verifier 구현**은 요구사항 정의/디버깅/프로토 수정까지 포함하면 과도하게 빡빡할 수 있습니다.
- Server Once 환경의 상태 누수/타이밍 이슈는 “테스트 안정화”에 많은 시간을 소모할 가능성이 높습니다.
- Phase 4에 “기존 Integration 삭제 + CI 추가 + README”가 포함되어 있어 병목 위험이 있습니다.

**권장 조정**
- Phase 3에 “격리/안정화 버퍼(2~3일)” 추가 권장.
- CI 및 기존 테스트 제거는 모든 검증이 안정화된 후 별도 단계로 분리하는 것이 안전합니다.

**판단**: 일정은 가능하나 **리스크 대비 완충 시간이 부족**합니다.

---

## 종합 결론

- **Server Once Pattern**은 타당하지만 “서버 종료 테스트”, “핸들러 누적”, “상태 누수” 보완이 필요합니다.
- **Proto Message Driven** 원칙은 올바르나, **문서 상 누락된 메시지와 proto 미정 항목**이 있어 완전하지 않습니다.
- **Client Response Only**는 방향은 맞으나, **콜백 검증의 식별성**을 강화해야 합니다.
- **테스트 격리**는 현재 전략만으로는 부족하며, 정리/핸들러 해제/리셋 메시지가 필요합니다.
- **73 테스트 ↔ 48 proto 매핑**은 현재 문서 기준으로 **정확하지 않습니다**.
- **Phase 1~4 일정**은 가능하나 **안정화 버퍼가 부족**해 보입니다.

### 우선 권장 액션
1. 모든 테스트 케이스에 대한 **명시적 proto 매핑 테이블** 재정리 (ErrorPacket/Disconnect 포함).
2. `Verifier` 별 핸들러 해제/정리 전략을 명문화.
3. 콜백 검증을 위한 **응답 필드 설계 보강** (콜백에서만 셋팅되는 값).
4. ServerLifecycle 테스트를 위한 **별도 서버 인스턴스 전략** 수립.
